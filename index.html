<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MeuPosto</title>
    <link href="favicon.ico" rel="shortcut icon" type="image/x-icon" />
</head>

<body>

    <script src="js/jquery-1.10.2.js"></script>

    <style>
        #googleMap {
            width: 100%;
        }

        body {
            padding-bottom: 0;
        }

        div.container.body-content {
            display: none;
        }
    </style>

    <!-- Redimensionar o mapa para ficar na tela toda -->
    <script>
        $(document).ready(function () {
            var bodyheight = $(window).height();
            $("#googleMap").height(bodyheight - 50);
        });

        // for the window resize
        $(window).resize(function () {
            var bodyheight = $(window).height();
            $("#googleMap").height(bodyheight - 50);
        });
    </script>

    <!-- Google Maps -->
    <script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyAkUbsC-g6QhmpIbKtC9Mr11cGziUKZBKw&signed_in=false"></script>
    <script>

        var map;
        var opendInfoWindow;
        var sorompilo;

		function carregarTodosOsPostos() {
            jQuery.ajax({
                url: 'py/meuposto_todos.py',
                type: "POST",
                data: "{ }",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                beforeSend: function () {
                    //alert("Start!!! ");
                },
                success: function (data) {
                    data.forEach(AddMarker);
                },
                failure: function (msg) { alert("Sorry!!! "); }
            });
        }

        function carregarPostos() {
            var bounds = map.getBounds();
            jQuery.ajax({
                url: 'py/meuposto.py',
                type: "POST",
                //data: "{'teste' : " + "'" + bounds + "'" + "}",
                data: bounds.toString(),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                beforeSend: function () {
                    //alert("Start!!! ");
                },
                success: function (data) {
                    data.forEach(AddMarker);
                },
                failure: function (msg) { alert("Sorry!!! "); }
            });
        }

        function carregarPostos2() {
            var bounds = map.getBounds();
            jQuery.ajax({
                url: 'WebService.asmx/RecuperarPostos',
                type: "POST",
                data: "{'jsonIn' : " + "'" + bounds + "'" + "}",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                beforeSend: function () {
                    //alert("Start!!! ");
                },
                success: function (data) {
                    data.forEach(AddMarker);
                },
                failure: function (msg) { alert("Sorry!!! "); }
            });
        }

        function AddMarker(value, index, ar) {
            // Create a marker and set its position.
            var myLatLng = { lat: parseFloat(value.Lat), lng: parseFloat(value.Lng) };
            var marker = new google.maps.Marker({
                map: map,
                position: myLatLng,
                title: 'Hello World!'
            });

            var infowindow = new google.maps.InfoWindow({
                content: '<b>' + value.Nome + '</b>' +
                    '<br />' + value.Logr + ', ' + value.Num + ' - ' + value.Bairro + 
                    '<br /><a href="#" onClick="tracarRota(\'\', \'' + value.Lat + ', ' + value.Lng + '\')">Rota</a>'
            });

            // preencher o conteúdo do balão a cada clique. utiliza apenas um 'infowindow'
            //google.maps.event.addListener(someMarker, 'click', function () {
            //    infowindow.setContent('Hello World');
            //    infowindow.open(map, this);
            //});

            // abre balão de info ao clicar no marker
            // e fecha o balão que estiver aberto
            marker.addListener('click', function () {
                if (opendInfoWindow != undefined) {
                    opendInfoWindow.close();
                }
                infowindow.open(map, marker);
                opendInfoWindow = infowindow;
            });

        }

        function initialize() {
            var mapProp = {
                center: new google.maps.LatLng(-19.858139, -43.919193),
                zoom: 15,
                panControl: true,
                zoomControl: true,
                mapTypeControl: true,
                scaleControl: false,
                streetViewControl: false,
                overviewMapControl: false,
                rotateControl: true,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            map = new google.maps.Map(document.getElementById("googleMap"), mapProp);
            //google.maps.event.addListenerOnce(map, 'idle', carregarTodosOsPostos);
            google.maps.event.addListener(map, 'idle', carregarPostos);

            /* localização */
            // Try W3C Geolocation (Preferred)
            if (navigator.geolocation) {
                browserSupportFlag = true;
                navigator.geolocation.getCurrentPosition(function (position) {
                    initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                    sorompilo = initialLocation;
                    map.setCenter(initialLocation);
                }, function () {
                    handleNoGeolocation(browserSupportFlag);
                });
            }
                // Browser doesn't support Geolocation
            else {
                browserSupportFlag = false;
                handleNoGeolocation(browserSupportFlag);
            }

            function handleNoGeolocation(errorFlag) {
                if (errorFlag == true) {
                    alert("Geolocation service failed.");
                    initialLocation = newyork;
                } else {
                    alert("Your browser doesn't support geolocation. We've placed you in Siberia.");
                    initialLocation = siberia;
                }
                map.setCenter(initialLocation);
            }
            /* fim localização */

        }
        google.maps.event.addDomListener(window, 'load', initialize);


        /* traçar rota */
        function tracarRota(enderDe, enderAte) {
            var directionsService;
            var directionsRenderer;

            directionsService = new google.maps.DirectionsService();

            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);

            /* pegar localização atual */
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    enderDe = position.coords.latitude + ", " + position.coords.longitude;
                }, function () {
                });
            }
            /* fim pegar localização atual */

            //directionsDisplay.setMap(null);

            var request = {
                origin: sorompilo,
                destination: enderAte,
                travelMode: google.maps.DirectionsTravelMode.DRIVING
            };

            directionsService.route(request, function (response, status) {
                if (status == google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(response);
                }
            });
        }
        /* fim traçar rota */


    </script>

    <div id="googleMap"></div>

</body>
</html>